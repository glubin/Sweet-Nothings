<!DOCTYPE html>
<html>
<head>
	<title>Chat Web App</title>
	<!-- Latest compiled and minified CSS -->
	<!-- <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css" integrity="sha512-dTfge/zgoMYpP7QbHy4gWMEGsbsdZeCXz7irItjcC3sPUFtf0kuFbDz/ixG7ArTxmDjLXDmezHubeNikyKGVyQ==" crossorigin="anonymous"> -->
	<script src="../socket.io/socket.io.js"></script>
	<style>.nabButton,.navColor{text-shadow:-.5px 0 #000,.5px 0 #000,0 .5px #000,0 -.5px #000}.navbar-default .navbar-nav>.open>a:focus,.navbar-default .navbar-nav>.open>a:hover,<style>.navbar-default .navbar-nav>.open>a{background-color:#46b8da}.navbar{background-color:#5bc0de;border-color:#46b8da}.navColor{color:#fff!important;font-size:20px}#formLogin{margin:20px}.enterLogin{margin-top:1%;line-height:1;ext-shadow:-.5px 0 #000,.5px 0 #000,0 .5px #000,0 -.5px #000}.signInDisclaimer{font-size:10px}.LogInBreak{margin-bottom:3%}.jumbotron{margin-top:8%;padding-top:1%}.productName{margin-bottom:2%;text-align:center}.box{display:inline;margin-right:3px}.productImage{border-radius:25px;max-height:100%;min-height:80%;max-width:100%;min-width:80%;display:block;margin-left:auto;margin-right:auto}.productInfo{margin-top:-2%}.productDescription{margin-left:2%;margin-top:-.3%}.nabIt{margin-top:4%;max-width:30%;text-align:center}.nabButton{margin-top:1%;font-size:20px}.price{width:20%;color:#000}</style>
	
	<script type ="text/javascript">
	var socket = io.connect('http://ec2-52-22-103-67.compute-1.amazonaws.com:1337/client.html');

	var myUserName = "";
	var uniqueID = "";
	var myRoom = "";
	var passUser = "";
	var passRoom = "";
	var userColor = "";

	function enterChatRoom(passUser, passRoom){
		passUser = passUser;
		passRoom = passRoom;
		if (passUser === undefined){
			// check password
			var socketio = io.connect();
			var roomName = event.target.id;
			var username = myUserName;

			console.log("you need to verify - " + roomName + ", " + username + ", " + uniqueID);
			socketio.emit("verify_open_room_ban", {room:roomName, username:username, uniqueID:uniqueID});
		} else {
			// password AND ban have already been verified
			var socketio = io.connect();
			var roomName = passRoom;
			// myRoom = event.target.id;
			
			var username = passUser;
			document.getElementById("postLogIn").style.display = "none";
			document.getElementById("currentRoom").style.visibility = "visible";
			document.getElementById("currentRoomTitle").innerHTML = roomName;
			socketio.emit("update_user_room", {room:roomName, user:username});
			socketio.emit("update_room_users", {room:roomName, user:username});
			socketio.emit("check_if_admin", {room:roomName, user:username, uniqueID:uniqueID});
			document.getElementById("goBack").style.visibility = "visible";
		}

		
		
	};

	function youWereAllowedIn(room, username){
		var socketio = io.connect();
		var roomName = room;
		var username = username;
		// myRoom = event.target.id;
		
		var username = document.getElementById("username").value;
		document.getElementById("postLogIn").style.display = "none";
		document.getElementById("currentRoom").style.visibility = "visible";
		document.getElementById("currentRoomTitle").innerHTML = roomName;
		socketio.emit("update_user_room", {room:roomName, user:username});
		socketio.emit("update_room_users", {room:roomName, user:username});
		socketio.emit("check_if_admin", {room:roomName, user:username, uniqueID:uniqueID});

		document.getElementById("goBack").style.visibility = "visible";
	}

	function checkPasswordChatRoom(){
		// send to server to check password, if correct, enterChatRoom
		var socketio = io.connect();
		var roomName = event.target.id;
		var specialID = event.target.id + "99";
		var userGuess = document.getElementById(specialID).value;
		// console.log("you want to check to see if " + userGuess + " is correct!");
		console.log(userGuess + ", " + uniqueID + ", " + roomName + ", " + myUserName);
		socketio.emit("check_user_guess_at_password", {userGuess:userGuess, uniqueID:uniqueID, room:roomName, user:myUserName});
	}


	document.addEventListener("DOMContentLoaded", function(event) {

		var socketio = io.connect();

		socketio.on("update_your_stats", function(data){
			console.log(data['lobbyStat'] + ", " + data['roomStat'] + ", " + data['privateSentStat'] + ", " + data['privateGotStat']);
			document.getElementById("generalSentMSG").innerHTML = "<div class='theStats'>Lobby Messages Sent: " + data['lobbyStat'] + "</div>";
			document.getElementById("roomSentMSG").innerHTML = "<div class='theStats'>Room Messages Sent: " + data['roomStat'] + "</div>";
			document.getElementById("privateSentOutMSG").innerHTML = "<div class='theStats'>Private Messages Sent: " + data['privateSentStat'] + "</div>";
			document.getElementById("privateGotInMSG").innerHTML = "<div class='theStats'>Private Messages Received: " + data['privateGotStat'] + "</div>";
		});


		socketio.on("display_private_message", function(data){
			console.log("you were privately sent " + data['message'] + " from " + data['sentBy']);
			document.getElementById("privateMessageStream").appendChild(document.createElement("hr"));
			// document.getElementById("privateMessageStream").appendChild(document.createTextNode(data['sentBy'] + " --> " + data['sentTo'] + ": " + data['message']));
			document.getElementById("privateMessageStream").innerHTML = document.getElementById("privateMessageStream").innerHTML + '<div style="color:' + data['colorToAdd']+ '">' + data['sentBy'] + " --> " + data['sentTo'] + ": " + data['message'] + '</div>';
		});


		socketio.on("open_room_was_verified_no_ban", function(data){
			youWereAllowedIn(data['room'],data['username']);
		});


		socketio.on("temp_kick_go_to_lobby", function(data){
			document.getElementById("goBack").style.visibility = "hidden";
			document.getElementById("currentRoom").style.visibility = "hidden";
			document.getElementById("postLogIn").style.display = "";
			document.getElementById("roomChatlog").innerHTML = "";
			document.getElementById("adminPanel").style.visibility = "hidden";
			
		});

		socketio.on("show_admin_panel", function(data){
			document.getElementById("adminPanel").style.visibility = "visible";
			// need to refresh who is in the chat rooms...
		});


		socketio.on("leaving_user_now_update", function(data){
			console.log("he left and " + data['user'] + ", " + data['room'] + " 00000000000000000");
			socketio.emit("update_user_room", {room:undefined, user:data['user']});
			socketio.emit("update_room_users", {room:data['room'], user:data['user']});
			// need to refresh who is in the chat rooms...
		});


		socketio.on("give_user_socket_ID", function(data){
			console.log("client side: " + data.uniqueID);
			uniqueID = data.uniqueID;
			console.log("okay your uniqueID has been set to " + uniqueID);
		});

		socketio.on("update_userList_in_chatroom", function(data) {
			console.log(data.users);
			document.getElementById("currentRoomMembers").innerHTML = "";
			document.getElementById("currentRoomMembers").innerHTML = data.users;
		});


		socketio.on("allow_entrance_into_room", function(data){
			enterChatRoom(data['username'], data['room']);
		});


		socketio.on("message_to_client",function(data) {
         //Append an HR thematic break and the escaped HTML of the new message
         console.log("MAKE SURE TO ADD " + data['colorToAdd']);
         document.getElementById("chatlog").appendChild(document.createElement("hr"));
         // var newNode = document.createTextNode(data['sentBy'] + ": " + data['message']);
         // newNode.style.color = data['colorToAdd'];
         // document.getElementById("chatlog").appendChild(newNode);
         document.getElementById("chatlog").innerHTML = document.getElementById("chatlog").innerHTML + '<div style="color:' + data['colorToAdd']+ '">' + data['sentBy'] + ": " + data['message'] + '</div>';
     });

		socketio.on("room_message_to_client",function(data) {
         //Append an HR thematic break and the escaped HTML of the new message
         document.getElementById("roomChatlog").appendChild(document.createElement("hr"));
         // document.getElementById("roomChatlog").appendChild(document.createTextNode(data['sentBy'] + ": " + data['message']));


         document.getElementById("roomChatlog").innerHTML = document.getElementById("roomChatlog").innerHTML + '<hr><div style="color:' + data['colorToAdd']+ '">' + data['sentBy'] + ": " + data['message'] + '</div>';
     });



		socketio.on("update_chatroom_list",function(data) {
			document.getElementById("chatroomList").innerHTML = "";
			console.log(data);
			var numChatRooms = data.message.length;
			var numUsers = data.userList.length;
			console.log("num of users: " + numUsers);
			console.log("length of arrays: " + numChatRooms);
			for (var i=0; i < numChatRooms; i++) {

				// add password slot
				if (data.message[i].message.password === null){
					var eltToAdd = '<button class="chtBtn btn btn-info" onclick="enterChatRoom()" id="' + data.message[i].message.roomName + '" class="chatRoomButton">Enter: ' + data.message[i].message.roomName + '</button>';

				} else{
					var eltToAdd = '<button class="chtBtn btn btn-info" onclick="checkPasswordChatRoom()" id="' + data.message[i].message.roomName + '" class="chatRoomButton">Enter: ' + data.message[i].message.roomName + "</button> <label for='roompassword'>Room Password</label> <input type='password' name='roompassword' id='" + data.message[i].message.roomName + "99' />";

				}


				var usersInThisRoom = " "

				for (var j=0; j < numUsers; j++){
					var roomToAdd = data.message[i].message.roomName;
					var curUser = data.userList[j].message.name;
					var curRoom = data.userList[j].message.room;
					if(roomToAdd === curRoom){
						usersInThisRoom = usersInThisRoom + " | " + curUser;
					}
				}
				console.log(usersInThisRoom + " are the users the room");

				eltToAdd = eltToAdd + usersInThisRoom + "<br>";
				document.getElementById("chatroomList").innerHTML = document.getElementById("chatroomList").innerHTML + eltToAdd;

				// addListenerToChatRoomButton(data.message[i].message.roomName);
			};
		});


document.getElementById("sendMainPageMessage").addEventListener("click", function(event){
	var msg = document.getElementById("message_input").value;
	console.log("you want your message to have a color of " + userColor);
	socketio.emit("message_to_server", {message:msg, sentBy:myUserName, uniqueID:uniqueID, userColor:userColor});
});

document.getElementById("sendRoomMessage").addEventListener("click", function(event){
	var msg = document.getElementById("roomMessageInput").value;
	var thisRoom = document.getElementById("currentRoomTitle").innerHTML;
	socketio.emit("room_message_to_server", {message:msg, room:thisRoom, sentBy:myUserName, uniqueID:uniqueID, userColor:userColor}); //update this
});

document.getElementById("backToLobbyButton").addEventListener("click", function(event){
	var currRoom = document.getElementById("currentRoomTitle").innerHTML;
	var username = myUserName;

	console.log(username + " wants to leave " + currRoom);
	socketio.emit("user_is_leaving_room", {room:currRoom, username:username});
	document.getElementById("goBack").style.visibility = "hidden";
	document.getElementById("currentRoom").style.visibility = "hidden";
	document.getElementById("postLogIn").style.display = "";
	document.getElementById("roomChatlog").innerHTML = "";
	document.getElementById("adminPanel").style.visibility = "hidden";
	document.getElementById("listingStats").style.visibility = "hidden";
	document.getElementById("generalSentMSG").innerHTML = "";
	document.getElementById("roomSentMSG").innerHTML = "";
	document.getElementById("privateSentOutMSG").innerHTML = "";
	document.getElementById("privateGotInMSG").innerHTML = "";

});


document.getElementById("signup").addEventListener("click", function(event){
	var username = document.getElementById("username").value;
	var color = document.getElementById("userColor").value;
	userColor = color;
	myUserName = username;
	var userInfo = {};
	userInfo.name = username;
	userInfo.room = null;
	userInfo.uniqueID = uniqueID;
	userInfo.lobbyMessagesSent = 0;
	userInfo.roomMessagesSent = 0;
	userInfo.privateMessagesSent = 0;
	userInfo.privateMessagesGot = 0;
	userInfo.color = userColor;
	console.log("your color is "  + userInfo.color);
	socketio.emit("create_user", {message:userInfo});
	document.getElementById("yourStats").style.visibility = "visible";
	document.getElementById("loginScreen").style.display = "none";
	document.getElementById("postLogIn").style.visibility = "visible";
	document.getElementById("currentRoom").style.visibility = "hidden";
	document.getElementById("statsSection").style.visibility = "visible";
});

document.getElementById("createChatroom").addEventListener("click", function(event){
	var username = document.getElementById("username").value;
	var chatroomName = document.getElementById("chatroom").value;
	var chatroomPassword = document.getElementById("chatpassword").value;
	var chatroomInfo = {};
	chatroomInfo.admin = username;
	chatroomInfo.roomName = chatroomName;
	if (chatroomPassword.length === 0){
						chatroomInfo.password = null;		//what happens if they want their password to be null...	
					} else {
						chatroomInfo.password = chatroomPassword;
					}	
					socketio.emit("create_chatroom", {message:chatroomInfo});
				});



document.getElementById("tempKickButton").addEventListener("click", function(event){
	var userToKick = document.getElementById("personToTempKick").value;
	var roomToKickOutOf = document.getElementById("currentRoomTitle").innerHTML;
	socketio.emit("temp_kick_out_user", {userToKick:userToKick, roomToKickOutOf:roomToKickOutOf});
});

document.getElementById("permKickButton").addEventListener("click", function(event){
	var userToKick = document.getElementById("personToPermKick").value;
	var roomToKickOutOf = document.getElementById("currentRoomTitle").innerHTML;
	// console.log("you want to perm kick out " + userToKick + " out of room " + roomToKickOutOf);
	socketio.emit("perm_kick_out_user", {userToKick:userToKick, roomToKickOutOf:roomToKickOutOf});
});

document.getElementById("privateMessageButton").addEventListener("click", function(event){
	var	userComingFrom = myUserName;
	var userToSentTo = document.getElementById("privateMessageTO").value;
	var privateMessageContent = document.getElementById("privateMessageContent").value;
	var currRoom = document.getElementById("currentRoomTitle").innerHTML;
	console.log("you want to send  " + privateMessageContent + " to " + userToSentTo + " from " + userComingFrom + " in room " + currRoom);
	socketio.emit("send_private_message", {messageContent:privateMessageContent, userSentTo:userToSentTo, userComingFrom:userComingFrom, currRoom:currRoom, uniqueID:uniqueID, userColor:userColor});
});

document.getElementById("yourStats").addEventListener("click", function(event){
	console.log("you want to see your stats");
	document.getElementById("postLogIn").style.display = "none";
	document.getElementById("currentRoom").style.visibility = "hidden";
	document.getElementById("goBack").style.visibility = "visible";
	document.getElementById("goBack").style.visibility = "visible";
	document.getElementById("listingStats").style.visibility = "visible";
	document.getElementById("adminPanel").style.visibility = "hidden";

	socketio.emit("get_user_stats", {username:myUserName, uniqueID:uniqueID});
});



});


</script>


</head>
<body>
	<div id="loginScreen">
		<h2 id="welcomeMsg">Welcome! Please Sign In.</h2>

		<div>
			<label for="username" class="loginUserMsg">User Name:</label>
			<input type="text" name="username" id="username" />
			<label class="loginUserMsg">User Color:</label>
			<input type="text" name="userColor" id="userColor" />
			<button id="signup" class="btn btn-success">Sign In</button>

		</div>

	</div>


	<!-- Fixed navbar -->
	<nav class="navbar navbar-default navbar-fixed-top">
		<div class="container">
			<div class="navbar-header">
				<button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
					<span class="sr-only">Toggle navigation</span>
					<span class="icon-bar"></span>
					<span class="icon-bar"></span>
					<span class="icon-bar"></span>
				</button>
				<a class="navbar-brand navColor" href="#">Nab It</a>
			</div>
			<div id="navbar" class="navbar-collapse collapse">
				<ul class="nav navbar-nav navbar-right">
					<!-- <li class="active"><a href="#">Home</a></li> -->
					<li><a class="navColor" href="#FAQ">FAQ</a></li>
					<li><a class="navColor" href="#">Sell</a></li>
					<li id="menuLogin">
						<a class="dropdown-toggle navColor" href="#" data-toggle="dropdown" id="navLogin">Log In</a>
						<div class="dropdown-menu">
							<div class="form" id="formLogin" class="formLogin"> 
								<input class="LogInBreak" name="email" id="email" type="text" placeholder="Email"> 
								<input name="password" id="password" type="password" placeholder="Password"><br>
								<button type="button" class="btn btn-info enterLogin">Log In</button>
							</div>
						</div>
					</li>
					<li class="dropdown" id="menuSignup">
						<a class="dropdown-toggle navColor" href="#" data-toggle="dropdown" id="navLogin">Sign Up</a>
						<div class="dropdown-menu">
							<div class="form" id="formLogin" class="formLogin"> 
								<input class="LogInBreak"name="emailsignup" id="emailsignup" type="text" placeholder="Email"><br>
								<input name="password" id="passwordsignup" type="passwordsignup" placeholder="Password"><br>
								<button type="button" id="signup" class="btn btn-info enterLogin">Sign Up</button>
								<h4 class="signInDisclaimer">* Currently, you must be a Wash U student.</h4>
							</div>
						</div>
					</li>
				</ul>

			</div><!-- nav coll.-->
		</div>
	</nav>


</body>
</html>